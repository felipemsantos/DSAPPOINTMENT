package org.tmf.dsmapi.schedule;

import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.tmf.dsmapi.commons.facade.AbstractFacade;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import org.tmf.dsmapi.commons.exceptions.BadUsageException;
import org.tmf.dsmapi.commons.exceptions.ExceptionType;
import org.tmf.dsmapi.commons.exceptions.UnknownResourceException;
import org.tmf.dsmapi.commons.utils.BeanUtils;
import org.tmf.dsmapi.appointment.model.Schedule;
import org.tmf.dsmapi.schedule.event.ScheduleEventPublisherLocal;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

@Stateless
public class ScheduleFacade extends AbstractFacade<Schedule> {

    @PersistenceContext(unitName = "DSAppointmentPU")
    private EntityManager em;
    @EJB
    ScheduleEventPublisherLocal publisher;
//    StateModelImpl stateModel = new StateModelImpl();

    public ScheduleFacade() {
        super(Schedule.class);
    }

    @Override
    protected EntityManager getEntityManager() {
        return em;
    }

    public void checkCreation(Schedule entity) throws BadUsageException, UnknownResourceException {

        Schedule sc = null;
        if (entity.getId() == null
                || entity.getId().isEmpty()) {
//            throw new BadUsageException(ExceptionType.BAD_USAGE_GENERIC, "While creating Schedule, id must be not null");
                //Do nothing create ok
                Logger.getLogger(ScheduleFacade.class.getName()).log(Level.INFO, "Schedule with autogenerated id is being posted");
        } else {
            try {
                sc = this.find(entity.getId());
                if (null != sc) {
                    throw new BadUsageException(ExceptionType.BAD_USAGE_GENERIC,
                            "Duplicate Exception, Schedule with same id :" + entity.getId() + " alreay exists");
                }
            } catch (UnknownResourceException ex) {
                //Do nothing create ok
                Logger.getLogger(ScheduleFacade.class.getName()).log(Level.INFO, "Schedule with id = " + entity.getId() + " is being posted", ex);
            }
        }

        //verify first status
        /**
        if (null == entity.getLifecycleState()) {
            entity.setLifecycleState(LifecycleStateValues.PENDING);
            throw new BadUsageException(ExceptionType.BAD_USAGE_MANDATORY_FIELDS, "LifecycleState is mandatory");
        } else {
            if (!entity.getLifecycleState().name().equalsIgnoreCase(LifecycleStateValues.PENDING.name())) {
                throw new BadUsageException(ExceptionType.BAD_USAGE_FLOW_TRANSITION, "lifecycleState " + entity.getLifecycleState().value() + " is not the first state, attempt : " + LifecycleStateValues.PENDING.value());
            }
        }
        */

    }

    public Schedule patchAttributs(String id, Schedule partialEntity) throws UnknownResourceException, BadUsageException {
        Schedule currentEntity = this.find(id);

        if (currentEntity == null) {
            throw new UnknownResourceException(ExceptionType.UNKNOWN_RESOURCE);
        }

        verifyStatus(currentEntity, partialEntity);

        ObjectMapper mapper = new ObjectMapper();
        JsonNode node = mapper.convertValue(partialEntity, JsonNode.class);
        partialEntity.setId(id);
        if (BeanUtils.patch(currentEntity, partialEntity, node)) {
            publisher.valueChangedNotification(currentEntity, new Date());
        }

        return currentEntity;
    }

    public void verifyStatus(Schedule currentEntity, Schedule partialEntity) throws BadUsageException {
        /**
        if (null != partialEntity.getLifecycleState()) {
            stateModel.checkTransition(currentEntity.getLifecycleState(), partialEntity.getLifecycleState());
            publisher.statusChangedNotification(currentEntity, new Date());
        }
        */
    }

}
